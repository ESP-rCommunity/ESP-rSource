#!/bin/bash
echo 'Script to extract data from UKCIP09 Weather Generator simulated'
echo 'climate files and convert these to ESP-r format climate files'
echo '' 
echo 'USAGE:'
echo 'This file should be edited to change yr001 to appropriate year'
echo 'e.g. yr002 and so on. Similarly range in clm_xtractor should also'
echo 'be changed from 3001 to other value upto 3030'
echo 'Hence this file should be run 30 times for 30 year climate data'
echo 'as is generated by the UKCIP09 WG'
echo 'Raw file names from the WG are:'
echo 'r_????_cntr_hly.csv = control (historic) hourly data'
echo 'r_????_scen_hly.csv = scenario(predicted) hourly data'
echo 'r_????_cntr_dly.csv = control (historic) daily data'
echo 'r_????_scen_dly.csv = scenario(predicted) daily data'
echo 'Each file holds 30 years data for one random sample ????'
echo 'There are a total of 100 sample files generated'
echo ' '
echo 'This script parses all 100 files but returns only one year data'
echo 'in ESP-r climate ascii format'
echo ' '

# Remove files holding daily averages
rm -rf *dly*

for fname in  `ls r_????_cntr_hly.csv` #r_0001_cntr_hly.csv
do
  # Init
  rootname=${fname:0:15}        # Root name of the file
  tempname=$rootname'.tmp'      # Scratch file
  echo "Working on $rootname"

  # Replace , with space so awk can read files
  sed s/','/' '/g $fname > $tempname 

  # Start writing final clm files
  finalname=$rootname'.yr001.clm' # Name of final climate file (binary)
  asciiname=$finalname'.a'        # Name of final climate file (ascii)
  echo "*CLIMATE" > $asciiname
  echo "# ascii climate file from UKCIP09 Weather Generator" >> $asciiname
  echo "# (c) Crown Copyright 2009" >> $asciiname
  echo "# col 1: Diffuse solar on the horizontal (W/m**2)" >> $asciiname
  echo "# col 2: External dry bulb temperature   (Tenths DEG.C)" >> $asciiname
  echo "# col 3: Direct normal solar intensity   (W/m**2)" >> $asciiname
  echo "# col 4: Prevailing wind speed           (Tenths m/s) " >> $asciiname
  echo "# col 5: Wind direction     (clockwise deg from north)" >> $asciiname 
  echo "# col 6: Relative humidity               (Percent)" >> $asciiname
  echo "ESP test climate                # site name" >> $asciiname
  echo " 1967,52.00,0.00,0   # year, latitude, long diff, direct normal rad flag" >> $asciiname
  echo " 1,365    # period (julian days)" >> $asciiname

  # Extract from UKCIP09 WG file and create ESP-r climate file
  awk -f clm_xtractor.awk $tempname >> $asciiname

  # Make binary climate files from ascii
clm -mode text << XXX
*
$finalname
k
b
y
$asciiname
n
y
-
XXX

  # Remove temporary file
  rm -rf $tempname # $asciiname (keep ascii climate file for reference)

done
  
echo ''
echo 'All ESP-r climate files have been created these are named as:'
echo '*.clm   = clm binary file'
echo '*.clm.a = clm ascii file'
echo 'Now move one directory up and zip all clm.a files for the archive'
echo 'Retain one climate file in the ESP-r_weather directory as well'
