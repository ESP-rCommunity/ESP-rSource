C  "AZALTS" CALCULATES THE SOLAR AZIMUTH AND THE SOLAR ALTITUDE
C   FOR A SPECIFIED HOUR OF A DAY

      SUBROUTINE AZALTS(IYD,IHR,ITS,RLONGT,RLATIT,SOLALT,SOLAZI)
      common/pophelp/h(60)
      COMMON/UAZALT/INIT,GLAT,GLON
      COMMON/OUTIN/IUOUT,IUIN
      logical close,OK,dok
      character h*72

      PI = 4.0 * ATAN(1.0)
C  IYD = DAY NUMBER OF THE YEAR (JAN 1=1, JAN 2=2,..., DEC 31=365)
C  ITS = TIME SYSTEM UNDER ANALYSIS, I.e. IF LOCAL MEAN
C        TIME (LMT), INPUT 1, IF LOCAL APPARENT TIME ,(LAT) ,INPUT 2.
C  RLONGT = LONGITUDINAL DIFFERENCE OF THE SITE MEASURED EAST(+VE)
C           OR WEST(-VE) OF THE REFERENCE TIME ZONE. IN BRITAIN THE
C           REFERENCE TIME ZONE IS AT GREENWICH (0 DEG LONGITUDE). (DEG)
C  RLATIT = LATITUDE OF SITE (NORTH +VE, SOUTH -VE) (DEGREES)

C  CHECK LATITUDE AND LONGITUDE.

      IF(INIT.EQ.1)goto 18
      IF(RLATIT.GT.90.0.OR.RLATIT.LT.-90.0)goto 14
      IF(RLONGT.GT.15.0.OR.RLONGT.LT.-15.0)goto 14

C  THE SIN AND COS OF THE LATITUDE ARE EVALUATED.
   15 SDLAT=ESIND(RLATIT)
      CDLAT=ECOSD(RLATIT)

C      CALCULATION OF THE EQUATION OF TIME
C
      IF(ITS.EQ.2)goto 11
      A=1.978*IYD-160.22
      B=0.989*IYD-80.11
      EQTIME=0.1645*ESIND(A)-0.1255*ECOSD(B)-0.025*ESIND(B)

C      CALCULATION OF THE DECLINATION
C
   11 A=280.1+0.9863*IYD
      DECLIN=23.45*ESIND(A)
      SDDECL=ESIND(DECLIN)
      CDDECL=ECOSD(DECLIN)

C  IF LMT IS USED THEN THE LONGITUDE AND EQUATION OF TIME
C  WILL EFFECT THE SOLAR TIME AT THE USERS SITE. A
C  CORRECTION WILL THEREFORE BE REQUIRED.
C
      IF(ITS.EQ.2)GOTO 1
      TIME=IHR+(EQTIME+(RLONGT/15.0))
      GOTO 2
    1 TIME=IHR
    2 TIMCOE=15.0*(12.0-TIME)
      CDTIME=ECOSD(TIMCOE)
      ABSTMC=ABS(TIMCOE)
      SDTIME=ESIND(TIMCOE)
      ASDTIM=ESIND(ABSTMC)
C
C      CALCULATION OF THE SOLAR ALTITUDE
C
      ALT=SDLAT*SDDECL+CDLAT*CDDECL*CDTIME
      SOLALT=ASIN(ALT)*180.0/PI
C
C            SOLAR AZIMUTH
C
      AZMUTH=(CDDECL*ASDTIM)/ECOSD(SOLALT)
      IF(AZMUTH.LT.-1.0)AZMUTH=-1.0
      IF(AZMUTH.GT.1.0)AZMUTH=1.0
      SOLAZI=ASIN(AZMUTH)*180.0/PI

C  Correct the azimuthal angle for time of day and whether
C  in north or south hemispheres.
      X=CDTIME
      call eclose(RLATIT,0.0,0.001,close)
      if(close)goto 13
      call eclose(RLATIT,90.0,0.001,close)
      if(close)goto 8
      Y=(CDLAT/SDLAT)*(SDDECL/CDDECL)
      goto 9
    8 Y=0.0
      goto 9
   13 Y=100.0*(SDDECL/CDDECL)
    9 IF(Y-X)3,4,5
    3 IF(RLATIT.GE.0.0)goto 6
      goto 7
    5 IF(RLATIT.LT.0.0)goto 6
      goto 7
    4 IF(TIME.LE.12.0)SOLAZI=90.0
      IF(TIME.GT.12.0)SOLAZI=270.0
      goto 10
    6 IF(TIME.LE.12.0)SOLAZI=180.0-SOLAZI
      IF(TIME.GT.12.0)SOLAZI=180.0+SOLAZI
      goto 10
    7 IF(TIME.GT.12.0)SOLAZI=360.0-SOLAZI
   10 CONTINUE
      RETURN
   14 WRITE(IUOUT,16)
   16 FORMAT(' Lat/Lon error in AZALT :',/,
     &' default site Glasgow (55.9N,4.15W)')
      dok=.false.
      h(1)='The latitude or longitude difference from time meridian'
      h(2)='is outwith the normal limits. A no exits program.'
      CALL ASKOK(' ',' Continue?',OK,dok,2)
      if(ok)goto 18
   17 CALL EPAGEND
      STOP
   18 RLATIT=GLAT
      RLONGT=GLON
      INIT=1
      goto 15
      END
